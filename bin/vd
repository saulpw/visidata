#!/usr/bin/env python3
#
# Usage: $0 [-d] [-r] [-f <filetype>] [<visidata options>] [<input_source> ...]

__version__ = 'saul.pw/VisiData v0.96'

import os
from visidata import *

def main():
    'Open the given sources using the VisiData interface.'
    import argparse
    parser = argparse.ArgumentParser(description=__doc__)

    parser.add_argument('inputs', nargs='*', help='initial sources')
    parser.add_argument('-d', dest='debug', action='store_true', default=False, help='abort on error')
    parser.add_argument('-r', dest='readonly', action='store_true', default=False, help='disable editing')
    parser.add_argument('-f', dest='filetype', default='', help='specify file type')

    for optname, v in vdtui.baseOptions.items():
        name, optval, defaultval, helpstr = v
        action = 'store_true' if optval is False else 'store'
        parser.add_argument('--' + optname.replace('_', '-'), action=action, dest=optname, default=optval, help=helpstr)

    args = parser.parse_args()

    # user customisations in config file in standard location
    for fnrc in ('.visidatarc', '$XDG_CONFIG_HOME/visidata/config', '~/.visidatarc'):
        p = Path(fnrc)
        if p.exists():
            exec(open(p.resolve()).read())
            break

    # command-line overrides
    for optname, optval in vars(args).items():
        if optname != 'inputs':
            vdtui.options[optname] = optval

    inputs = list(args.inputs)

    if not sys.stdin.isatty():
        # duplicate stdin for input and reopen tty as stdin
        src = PathFd('stdin', open(os.dup(0)))
        f = open('/dev/tty')
        os.dup2(f.fileno(), 0)
        inputs.append(src)

    if not inputs:
        inputs = ['.']

    sources = []
    for src in inputs:
        vs = openSource(src)
        vdtui.vd().editlog.openHook(vs, src)
        sources.append(vs)

    vdtui.run(sources)

if __name__ == '__main__':
    vdtui.status(__version__)
    vdtui.addGlobals(globals())
    main()
    os._exit(0)  # cleanup can be expensive with large datasets
